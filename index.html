<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
  
  	<meta http-equiv="Content-Security-Policy" content="
		default-src 'self' 'unsafe-inline' ws://10.3.125.63:3000 ws://10.3.125.203:3000 ws://192.168.1.100:3000 http://code.jquery.com http://ajax.aspnetcdn.com https://code.jquery.com http://cdn.jtsage.com https://maps.googleapis.com https://csi.gstatic.com https://maps.gstatic.com https://fonts.googleapis.com https://fonts.gstatic.com https://khms0.googleapis.com https://khms1.googleapis.com  https://ssl.gstatic.com gap: data: blob: filesystem: ;
	"  />
     <link rel="stylesheet"
    href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">

	<script
	src="https://code.jquery.com/jquery-2.1.4.js"
	integrity="sha256-siFczlgw4jULnUICcdm9gjQPZkw/YPDqhQ9+nAOScE4="
	crossorigin="anonymous"></script>
	
	<script 
    src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    
       <link href="http://cdn.jtsage.com/jtsage-datebox/4.1.1/jtsage-datebox-4.1.1.jqm.min.css" rel="stylesheet" type="text/css">
    <script src="http://cdn.jtsage.com/jtsage-datebox/4.1.1/jtsage-datebox-4.1.1.jqm.min.js" type="text/javascript"></script>
    <script src="http://cdn.jtsage.com/jtsage-datebox/i18n/jtsage-datebox.i18n.fi.utf8.min.js" type="text/javascript" ></script>
     <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.15.0/jquery.validate.min.js" type="text/javascript" ></script>

    <link rel="stylesheet" type="text/css" href="css/index.css" />

	<link rel="stylesheet" type="text/css" href="css/icon-pack-custom.css" />


    <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
    <link rel="stylesheet" href="css/themes/mobiili.css" />
    <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
    
      <style type="text/css">
        .virhe {
            color: red;
            font-size: 130%;
            
        }
        input.kenttaVirhe, textarea.kenttaVirhe {
            border: 1px solid red !important;
        }
          
          #data {
              border-style: solid;
              border-width: 1px;
              border-radius: 20px;
              padding-left: 5px;
              background-color: lightgrey;
              
          }
        
    </style>
    
    <title>Matka-app</title>
</head>

<body>	
	
	<!-- Vain dynaamiset header ja footer ominaisuudella data-position="fixed" pysyvät paikallaan vilkkumatta, kun sivua vaihdetaan -->
	<div data-role="header" data-theme="a" data-position="fixed">
		
		<h1></h1>
		<div data-role="navbar" id="navi">
			<ul>
				<li><a href="#etusivu" class="ui-btn ui-icon-home ui-btn-icon-top  ui-mini">Etusivu</a></li>
				<li><a href="#lisaaMatkaSivu" class="ui-btn ui-icon-navigation ui-btn-icon-top ui-mini">Lisää matka</a></li>
				<li><a href="#haeMatkaSivu"  class="ui-btn ui-icon-location ui-btn-icon-top ui-mini">Kaikki matkat</a></li>
				
			</ul>
		</div>
	</div>
	
	<div data-role="footer" data-theme="b" data-position="fixed">
		<h4>Matka-app</h4>
	</div>
	
	<div data-role="page" id="etusivu" data-title="Etusivu">
	
	    <div role="main" class="ui-content ui-body-a">
            
            <h4>Tervetuloa käyttämään Matka-appia!</h4>
            
            <p>Ohjelmalla voit tallentaa matkoja sekä reissuja myöhempää muistelua varten. Laitat lähtöpaikan ja määränpään sekä kuvauksen reissusta
            </p>
            <br>
            <p>Sovelluksessa tulen käyttämään todennäköisesti vain paikannusta, jolla saan lähtöpaikaksi kyseisen sijainnin.</p>
            

	    </div> 

    </div> <!-- /page -->
	
	<div data-role="page" id="lisaaMatkaSivu" data-title="Lisää matka">
  
	    <div role="main" class="ui-content ui-body-a">
			<form action="#" method="post" id="lisaaMatkaForm">
	            
                <div class="ui-field-contain">
                    <label for="paiva">Päiväys</label>
                    <input type="text" id="paiva" name="paiva">
                </div>
                
                     
            
                
                <div class="ui-field-contain">
                    <label for="lahto">Lähtöpaikka</label>
                    <input type="text" id="lahto" name="lahto">
                </div>
                
                <div class="ui-field-contain">
                    <label for="maaranpaa">Määränpää</label>
                    <input type="text" id="maaranpaa" name="maaranpaa">
                </div>
                
         
                  
                <div class="ui-field-contain"> 
                    <label for="kuvaus">Kuvaus</label>
                    <textarea id="kuvaus" name="kuvaus"></textarea>
                </div>           
     
                <button type="button" class="ui-btn ui-corner-all ui-btn-inline" id="lisaa" name="lisaa">Lisää</button>	
                <a href="#" class="ui-btn ui-corner-all ui-btn-a ui-btn-icon-left ui-icon-delete ui-btn-inline" id="tyhjenna" name="tyhjenna">Tyhjennä</a>
			 </form> 
        
            
            </div> <!-- /content -->
		
    </div> <!-- /page -->
	
	<div data-role="page" id="haeMatkaSivu" data-title="Kaikki matkat">
  
	    <div role="main" class="ui-content ui-body-a">
            <h1>Tallentetut matkat</h1>
            <div id="vastaus"></div>
            
             <button type="button" id="clear" class="ui-btn ui-corner-all ui-btn-inline">Poista</button>      
            <button type="button" id="show" class="ui-btn ui-corner-all ui-btn-inline">Näytä matkat</button>      
	    </div> <!-- /content -->
 
    </div> <!-- /page -->
	

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>

    <script type="text/javascript">
		$(document).on("pagebeforecreate", function () {
	
			$( "[data-role='header']" ).toolbar().enhanceWithin();
			$( "[data-role='footer']" ).toolbar(); 	
		})
        
           $(document).on("pagecreate", "#lisaaMatkaSivu", function () {
	       $("#paiva").val(tanaan());
            $("#paiva").datebox({
                mode: "calbox",
                useFocus: true,
                overrideCalStartDay:1,
                usePlaceholder: "Lähtöpäivä"
                
            }
        )
            
              
			  $("#lisaa").on("tap", function() {
                if ($("#lisaaMatkaForm").valid()) {
                    lisaaMatkaDB();
                    tyhjennaLomake();
                    $("#paiva").val(tanaan());
                }
            
        })
               $("#tyhjenna").on("tap", function() {
                tyhjennaLomake();
                   $("#paiva").val(tanaan());
        })			
})
        
        // SIVUJEN KOKO 
		$(document).on("pagecontainershow", function(){
			$(".ui-content").height(getRealContentHeight());
		})

		$(window).on("resize orientationchange", function(){
			$(".ui-content").height(getRealContentHeight());
		})
		
		function getRealContentHeight() {
			var activePage = $.mobile.pageContainer.pagecontainer("getActivePage"),
				screen = $.mobile.getScreenHeight(),
				header = $(".ui-header").hasClass("ui-header-fixed") ? $(".ui-header").outerHeight() - 1 : $(".ui-header").outerHeight(),
				footer = $(".ui-footer").hasClass("ui-footer-fixed") ? $(".ui-footer").outerHeight() - 1 : $(".ui-footer").outerHeight(),
				contentMargins = $(".ui-content", activePage).outerHeight() - $(".ui-content", activePage).height();
			
			var contentHeight = screen - header - footer - contentMargins;	
			
			return contentHeight;
		}
		
		$( document ).on("pagecontainerchange", function() {
			navi();
		})

        //SWIPE LEFT JA RIGHT SIVUJEN VÄLILLÄ
		$(document).on("swipeleft", ".ui-page", function(event) { 
	
			if(event.handled !== true) { // Annetaan tapahtua vain kerran
				var nextpage = $(this).next("div[data-role='page']");
				
				if (nextpage.length == 0) {
					nextpage = $("div[data-role='page']:first");
				}
		
				$.mobile.pageContainer.pagecontainer ("change", nextpage);
				event.handled = true;
				navi();
			}
			return false;
		})
		
		$(document).on("swiperight", ".ui-page", function(event) { 
		
			if(event.handled !== true) {
				var prevpage = $(this).prev("div[data-role='page']");

				if (prevpage.length == 0) {
					prevpage = $("div[data-role='page']:last");
				}
				
				$.mobile.pageContainer.pagecontainer ("change", prevpage);
				event.handled = true;
				navi();
			}
			return false;
		})
        
        //NAVIBAR
		function navi() {
			// attribuutti data-title
			var current = $( ".ui-page-active" ).jqmData( "title" );// data-title
			
			$( "[data-role='header'] h1" ).text( current );
			
			$( "[data-role='navbar'] a.ui-btn-active" ).removeClass( "ui-btn-active" );
			
			$( "[data-role='navbar'] a" ).each(function() {
				if ( $( this ).text() === current ) {
					$( this ).addClass( "ui-btn-active" );
				}
			})
		}
        
        // PÄIVÄYS JA KALENTERI
        
         function tanaan() {
		
			var nyt = new Date();
			var kuukausi = nyt.getMonth() + 1;
			if(kuukausi < 10) {
				kuukausi= "0" + kuukausi;
			}
			
			var paiva = nyt.getDate();
			if(paiva < 10) {
			paiva= "0" + paiva;
			}
			
			var vuosi= nyt.getFullYear();
			
			return paiva + "." +kuukausi+"."+vuosi;
         }
        
       
        
     
        // FORMIN TYHJENNYS
        
         function tyhjennaLomake() {
            $("#lisaaMatkaForm input, #lisaaMatkaForm textarea").each(function() {
               document.getElementById("lisaaMatkaForm").reset(); 
            })
            validator.resetForm();
            
        }
        
        // VALIDOINTI
        
                
        var validator = $("#lisaaMatkaForm").validate({
			errorClass: "virhe",
			errorElement: "div",				
			rules: {
				paiva:  {
					required: true,   
				},		
				lahto:  {
                    required: true,
                    minlength:2,		
				},
				maaranpaa:  {
					required: true,
                    minlength:2,
				},
                 kuvaus:  {
					required: true,
                     minlength: 1,
                     maxlength: 255,
				},	
			},
			messages: {
				paiva: {
                    required: "Syötä päiväys",	
				},
				lahto: {
                    required: "Syötä lähtöpaikka",
                    minlength: jQuery.validator.format("Vähintään {0} merkkiä"),
				},
				maaranpaa: {
					required: "Syötä määränpää",
                     minlength: jQuery.validator.format("Vähintään {0} merkkiä"),
                },
                kuvaus: {
					required: "Syötä kuvaus",
                     minlength: jQuery.validator.format("Vähintään {0} merkkiä"),
                     maxlength: jQuery.validator.format("Maksimissaan {0} merkkiä"),
				},
			},
			highlight: function(element) {
                
                $(element).addClass("kenttaVirhe");
				
			}, 
			unhighlight: function(element) {
				$(element).removeClass("kenttaVirhe");
			},
			errorPlacement: function(error, element) {
				error.insertAfter(element.parent());
			},
		})
         
        
        // LISÄTÄÄN TIETOKANTAAN
        
        function lisaaMatkaDB() {
              
				var trip = {paiva : $('#paiva').val(), lahto : $('#lahto').val(), maaranpaa : $('#maaranpaa').val(), kuvaus : $('#kuvaus').val()};
                var db = indexedDB.open('trips', 1);
                
                db.onupgradeneeded = (event) => {
                    var res = event.target.result;
                    var objStore= res.createObjectStore('travels', {autoIncrement:true});
                    
                }
                
                db.onsuccess= (event) => {
                    
                    var res = event.target.result;
                    var transaction = res.transaction(['travels'], "readwrite");
                    var objStore = transaction.objectStore('travels');
                    objStore.add(trip);
                    
                    objStore.getAll().onsuccess= (event) => {
                        
                    var rows = event.target.result.length;
                  
                    var htmlData = "<div id='data'>";
                    for(var i=0; i < rows; i++) {
                      
                        htmlData += "<p>" + "Päiväys: "+ event.target.result[i].paiva +"<br>"
                        +"Lähtöpaikka: "+event.target.result[i].lahto + "<br>"
                        +"Määränpää: "+event.target.result[i].maaranpaa + "<br>"
                        +"Kuvaus: "+event.target.result[i].kuvaus + "</p>";
                      
                }
                 htmlData += "</div>";
                
                
                $('#vastaus').html(htmlData);
                        
                    
                }
               
                }
            
        }
        
        // TYHJENNETÄÄN TIETOKANTA
         $('#clear').click(function() {
                 var db = indexedDB.open('trips', 1);
                
                db.onsuccess= (event) => {
                
			     var res = event.target.result;
                    var transaction = res.transaction(['travels'], "readwrite");
                    var objStore = transaction.objectStore('travels');
                    objStore.clear();
                    res.close();
                } 
               
                
                 $('#data').html('');
                
            }); 
        
        //NÄYTÄ MATKAT
         $('#show').click(function() {
             
          var db = indexedDB.open('trips', 1);
                
                db.onsuccess= (event) => {
                    
                    var res = event.target.result;
                    var transaction = res.transaction(['travels'], "readwrite");
                    var objStore = transaction.objectStore('travels');
                
                    objStore.getAll().onsuccess= (event) => {
                        
                    var rows = event.target.result.length;
                  
                    var htmlData = "<div id='data'>";
                    for(var i=0; i < rows; i++) {
                      
                        htmlData += "<p>" + "Päiväys: "+ event.target.result[i].paiva +"<br>"
                        +"Lähtöpaikka: "+event.target.result[i].lahto + "<br>"
                        +"Määränpää: "+event.target.result[i].maaranpaa + "<br>"
                        +"Kuvaus: "+event.target.result[i].kuvaus + "</p>";
                      
                }
                 htmlData += "</div>";
                
                
                $('#vastaus').html(htmlData);
                        
                    
                }
               
                }
              });
        
        
        //PAIKKAKUNTA LÄHTÖPAIKAKSI
        
        navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, {timeout:10000});
 
        function onLocationSuccess(position) {
            haePaikkakunta(position.coords.latitude, position.coords.longitude);
            }
            function onLocationError() {
				
				alert("Paikannus ei onnistu");
                }
 

        function haePaikkakunta(lat, lon) {
            $.ajax({
                url: "http://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat + "," + lon,
                dataType: "json",
                timeout: 5000,
                cache:false
            })                        
                .done(function(data){ 
      
                var addressComponents = data.results[0].address_components;
				for(i = 0; i <addressComponents.length;i++){
					var types = addressComponents[i].types
						
					if(types=="locality,political"){
						$("#lahto").val(addressComponents[i].long_name); 
					}
				}	
   
});
}

    </script>

</body>

</html>